@model DoAn.Models.SanPham

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
    List<DoAn.Models.ProductViewModel> dslq = ViewBag.ds;
    var danhGias = ViewBag.DanhGias as List<dynamic>;
    var diemTrungBinh = ViewBag.DiemTrungBinh;
    var soLuongDanhGia = ViewBag.SoLuongDanhGia;
}

<div class="page-wrapper">
    <main class="main">
        <nav aria-label="breadcrumb" class="breadcrumb-nav border-0 mb-0">
            <div class="container d-flex align-items-center">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="~/Home">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a href="~/SanPhams">Sản phẩm</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Chi tiết</li>
                </ol>
            </div>
        </nav>

        <div class="mt-3"></div>

        <div class="page-content">
            <div class="container">
                <div class="product-details-top">   
                    <div class="row">
                        <div class="col-md-6">
                            <div class="product-gallery product-gallery-vertical">
                                <div class="row">
                                    <figure class="product-main-image">
                                        <img id="product-zoom" src="@Url.Content("~/wwwroot/images/" + Model.hinhanh)" alt="product image">
                                    </figure>

                                    <div id="product-zoom-gallery" class="product-image-gallery">
                                        @if (!string.IsNullOrEmpty(Model.hinhanh2))
                                        {
                                            <a class="product-gallery-item" href="#" data-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh2)" data-zoom-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh2)">
                                                <img src="@Url.Content("~/wwwroot/images/" + Model.hinhanh2)" alt="product image 2">
                                            </a>
                                        }

                                        @if (!string.IsNullOrEmpty(Model.hinhanh3))
                                        {
                                            <a class="product-gallery-item" href="#" data-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh3)" data-zoom-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh3)">
                                                <img src="@Url.Content("~/wwwroot/images/" + Model.hinhanh3)" alt="product image 3">
                                            </a>
                                        }

                                        @if (!string.IsNullOrEmpty(Model.hinhanh4))
                                        {
                                            <a class="product-gallery-item" href="#" data-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh4)" data-zoom-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh4)">
                                                <img src="@Url.Content("~/wwwroot/images/" + Model.hinhanh4)" alt="product image 4">
                                            </a>
                                        }

                                        @if (!string.IsNullOrEmpty(Model.hinhanh5))
                                        {
                                            <a class="product-gallery-item" href="#" data-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh5)" data-zoom-image="@Url.Content("~/wwwroot/images/" + Model.hinhanh5)">
                                                <img src="@Url.Content("~/wwwroot/images/" + Model.hinhanh5)" alt="product image 5">
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="product-details">
                                <h1 class="product-title">@Html.DisplayFor(model => model.tensp)</h1>

                                <div class="ratings-container">
                                    <div class="ratings">
                                        <div class="ratings-val" style="width: @(diemTrungBinh * 20)%"></div>
                                    </div>
                                    <a class="ratings-text" href="#product-review-link" id="review-link">(@soLuongDanhGia đánh giá)</a>
                                </div>

                                <div class="product-price">
                                    @{ 
                                        decimal gia = (decimal)Model.giaban;
                                        string formattedPrice = gia.ToString("#,##0");
                                    }
                                    @formattedPrice đ
                                </div>

                                <div class="product-content">
                                    <p>@Model.mota</p>
                                </div>

                                <div class="details-filter-row details-row-size">
                                    <label>CPU:</label>
                                    <div class="product-nav product-nav-thumbs">
                                        @Html.DisplayFor(model => model.CPU)
                                    </div>
                                </div>
                                <div class="details-filter-row details-row-size">
                                    <label>RAM:</label>
                                    <div class="product-nav product-nav-thumbs">
                                        @Html.DisplayFor(model => model.RAM)
                                    </div>
                                </div>
                                <div class="details-filter-row details-row-size">
                                    <label>SSD:</label>
                                    <div class="product-nav product-nav-thumbs">
                                        @Html.DisplayFor(model => model.SSD)
                                    </div>
                                </div>
                                <div class="details-filter-row details-row-size">
                                    <label>VGA:</label>
                                    <div class="product-nav product-nav-thumbs">
                                        @Html.DisplayFor(model => model.carddohoa)
                                    </div>
                                </div>
                                <div class="details-filter-row details-row-size">
                                    <label>Kho: </label>
                                    <div class="product-nav product-nav-thumbs">
                                        @Html.DisplayFor(model => model.soluong) Sản Phẩm
                                    </div>
                                </div>
                                
                                <div class="details-filter-row details-row-size">
                                    <label for="qty">Số lượng:</label>
                                    <div class="product-details-quantity">
                                        <input type="number" id="qty" class="form-control" data-qtyproduct="@Model.soluong" value="1" min="1" max="100" step="1" data-decimals="0" required>
                                    </div>
                                </div>

                                <div class="product-details-action">
                                    <button id="addcart" class="btn-product btn-cart" data-product-id="@Model.masp" ><span>Thêm vào giỏ hàng</span></button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="product-details-tab">
                    <ul class="nav nav-pills justify-content-center" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="product-desc-link" data-toggle="tab" href="#product-desc-tab" role="tab" aria-controls="product-desc-tab" aria-selected="true">Mô tả</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="product-info-link" data-toggle="tab" href="#product-info-tab" role="tab" aria-controls="product-info-tab" aria-selected="false">Thông số kỹ thuật</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="product-review-link" data-toggle="tab" href="#product-review-tab" role="tab" aria-controls="product-review-tab" aria-selected="false">Đánh giá (@soLuongDanhGia)</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="product-desc-tab" role="tabpanel" aria-labelledby="product-desc-link">
                            <div class="product-desc-content">
                                <h3>Mô tả</h3>
                                <p>@Model.mota</p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="product-info-tab" role="tabpanel" aria-labelledby="product-info-link">
                            <div class="product-desc-content">
                                <h3>Thông tin sản phẩm</h3>
                                <p><strong>CPU:</strong> @Model.CPU</p>
                                <p><strong>RAM:</strong> @Model.RAM</p>
                                <p><strong>Ổ cứng:</strong> @Model.SSD</p>
                                <p><strong>Card đồ họa:</strong> @Model.carddohoa</p>
                                <p><strong>Hệ điều hành:</strong> @Model.OS</p>
                                <p><strong>Màn hình:</strong> @Model.manhinh</p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="product-review-tab" role="tabpanel" aria-labelledby="product-review-link">
                            <div class="reviews">
                                <h3 class="review-title">Đánh giá (@soLuongDanhGia)</h3>
                                <div class="review-list">
                                    @if (danhGias != null && danhGias.Any())
                                    {
                                        foreach (var danhGia in danhGias)
                                        {
                                            <div class="review-item">
                                                <div class="review-header">
                                                    <div class="review-author">
                                                        <i class="icon-user"></i>
                                                        <span>@danhGia.KhachHang</span>
                                                    </div>
                                                    <div class="review-rating">
                                                        <div class="ratings">
                                                            <div class="ratings-val" style="width: @(danhGia.DiemDanhGia * 20)%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="review-content">
                                                    <p>@danhGia.NoiDungDanhGia</p>
                                                </div>
                                                <div class="review-date">
                                                    <i class="icon-calendar"></i>
                                                    <span>@danhGia.NgayDanhGia.ToString("dd/MM/yyyy")</span>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="no-reviews">
                                            <i class="icon-comment-alt"></i>
                                            <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                                        </div>
                                    }
                                </div>

                                @if (Session["ma"] != null)
                                {
                                    <div class="review-form">
                                        <h3 class="review-form-title">Viết đánh giá</h3>
                                        <form id="review-form" action="@Url.Action("AddReview", "SanPhams")" method="post">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="MaSanPham" value="@Model.masp" />
                                            
                                            <div class="form-group rating-group">
                                                <label>Điểm đánh giá:</label>
                                                <div class="rating-input">
                                                    <input type="radio" name="DiemDanhGia" value="1" id="1"><label for="1">☆</label>
                                                    <input type="radio" name="DiemDanhGia" value="2" id="2"><label for="2">☆</label>
                                                    <input type="radio" name="DiemDanhGia" value="3" id="3"><label for="3">☆</label>
                                                    <input type="radio" name="DiemDanhGia" value="4" id="4"><label for="4">☆</label>
                                                    <input type="radio" name="DiemDanhGia" value="5" id="5"><label for="5">☆</label>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <textarea name="NoiDungDanhGia" class="form-control" rows="3" required placeholder="Hãy chia sẻ cảm nhận của bạn về sản phẩm..."></textarea>
                                            </div>

                                            <button type="submit" class="btn btn-primary btn-review">Gửi đánh giá</button>
                                        </form>
                                    </div>
                                }
                                else
                                {
                                    <div class="login-required">
                                        <i class="icon-lock"></i>
                                        <p>Vui lòng <a href="@Url.Action("Index", "Login")">đăng nhập</a> để viết đánh giá.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <h2 class="title text-center mb-4">GỢI Ý SẢN PHẨM</h2>

                <div class="owl-carousel owl-simple carousel-equal-height carousel-with-shadow" data-toggle="owl"
                     data-owl-options='{
                            "nav": false,
                            "dots": true,
                            "margin": 20,
                            "loop": false,
                            "responsive": {
                                "0": {
                                    "items":1
                                },
                                "480": {
                                    "items":2
                                },
                                "768": {
                                    "items":3
                                },
                                "992": {
                                    "items":4
                                },
                                "1200": {
                                    "items":4,
                                    "nav": true,
                                    "dots": false
                                }
                            }
                        }'>
                    @foreach (var item in dslq)
                    {
                        <div class="product">
                            <figure class="product-media">
                                @*<span class="product-label label-sale">Sale</span>*@
                                <a href="~/SanPhams/Details/@item.Product.masp">
                                    <img src="@Url.Content("~/wwwroot/images/" + item.Product.hinhanh)" alt="Product image" class="product-image">
                                </a>

                                <div class="product-action-vertical">
                                </div>

                                <div class="product-action">
                                    <button id="addcart" data-product-id="@item.Product.masp" class="btn-product btn-cart" title="Add to cart">
                                        <span>Thêm vào giỏ</span>
                                    </button>
                                </div>
                            </figure>

                            <div class="product-body">
                                <h3 class="product-title"><a href="~/SanPhams/Details/@item.Product.masp">@item.Product.tensp</a></h3>
                                <div class="product-price">
                                    @{
                                        decimal giaban = (decimal)item.Product.giaban;
                                        string f = giaban.ToString("#,##0");
                                    }
                                    @f đ
                                </div>
                                <div class="ratings-container">
                                    <div class="ratings">
                                        <div class="ratings-val" style="width: 80%;"></div>
                                    </div>
                                    <span class="ratings-text">(@item.ReviewCount đánh giá)</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>
</div>
<button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

<script>
    $(document).ready(function() {
        // Handle gallery image clicks
        $('.product-gallery-item').click(function(e) {
            e.preventDefault();
            var newImageSrc = $(this).data('image');
            $('#product-zoom').attr('src', newImageSrc);
        });

        $('.btn-cart').click(function() {
            var productId = $(this).data('product-id');
            var qty = $('#qty').val();

            $.ajax({
                url: '@Url.Action("AddCart2", "SanPhams")',
                type: 'POST',
                data: { id: productId, soluong: qty },
                success: function (result) {
                    if (result.success && result.message=="T") {
                        toastr.success("Thêm vào giỏ hàng thành công", "Thành Công");
                        setTimeout(function () {
                            location.reload();
                        }, 1500);

                    }
                    else if (result.success && result.message == "F") {
                            toastr.error("Thêm vào giỏ hàng không thành công", "Không thành Công");
                    }
                    else
                    {
                        window.location.href = '/Login/Index';
                    }
                },
                error: function() {

                    alert('Đã xảy ra lỗi!');
                }
            });

        });
    });

    var inputElement = document.getElementById('qty');
    inputElement.addEventListener('change', function () {
        var val = inputElement.value;
        var sl = parseInt(val);
        var soluong = $(this).data('qtyproduct');
        if (sl > soluong) {
            toastr.warning("Số lượng kho không đủ !", "Cảnh Báo");
        }
    });
</script>

<style>
    .review-title {
        font-size: 24px;
        margin-bottom: 30px;
        color: #333;
        text-align: center;
    }

    .review-list {
        margin-bottom: 40px;
    }

    .review-item {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .review-author {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .review-author i {
        color: #666;
    }

    .review-content {
        margin: 15px 0;
        line-height: 1.6;
        color: #555;
    }

    .review-date {
        color: #888;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .no-reviews {
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .no-reviews i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 15px;
    }

    .review-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .review-form-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
    }

    .rating-group {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .rating-input {
        display: flex;
        gap: 3px;
        flex-direction: row-reverse;
    }

    .rating-input input[type="radio"] {
        display: none;
    }

    .rating-input label {
        font-size: 18px;
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
    }

    .rating-input input[type="radio"]:checked ~ label,
    .rating-input input[type="radio"]:checked + label {
        color: #ffc107;
    }

    .rating-input label:hover,
    .rating-input label:hover ~ label {
        color: #ffc107;
    }

    .btn-review {
        padding: 8px 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 10px;
    }

    .login-required {
        text-align: center;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 30px;
    }

    .login-required i {
        font-size: 36px;
        color: #666;
        margin-bottom: 15px;
    }

    .login-required a {
        color: #007bff;
        text-decoration: none;
    }

    .login-required a:hover {
        text-decoration: underline;
    }
</style>
